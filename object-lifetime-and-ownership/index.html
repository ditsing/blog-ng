<!DOCTYPE html>
<html lang="">
<head>

	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	<title>Object lifetime and ownership</title>
	<meta name="HandheldFriendly" content="True" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<link rel="stylesheet" type="text/css" href="/assets/css/style.css?v=5aa16560c6" />

	<script>
			var siteUrl = 'https://www.ditsing.com';
	</script>

	<script>
			var localTheme = localStorage.getItem('attila_theme');
			switch (localTheme) {
					case 'dark':
							document.documentElement.classList.add('theme-dark');
							break;
					case 'light':
							document.documentElement.classList.add('theme-light');
							break;
					default:
							break;
			}
	</script>

	<link rel="icon" href="/favicon.png" type="image/png" />
    <link rel="canonical" href="https://www.ditsing.com/object-lifetime-and-ownership/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="https://www.ditsing.com/object-lifetime-and-ownership/amp/" />
    
    <meta property="og:site_name" content="顿" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Object lifetime and ownership" />
    <meta property="og:description" content="Before learning Rust, I never thought about object lifetime and ownership that much. It turns out they have many things to do with memory safety and thread safety. Nowadays I think about lifetime and ownership all the time, even when writing programs in C++. Here is a summary of my" />
    <meta property="og:url" content="https://www.ditsing.com/object-lifetime-and-ownership/" />
    <meta property="article:published_time" content="2021-09-08T22:07:33.000Z" />
    <meta property="article:modified_time" content="2021-09-28T16:52:35.000Z" />
    <meta property="article:tag" content="Lifetime" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Object lifetime and ownership" />
    <meta name="twitter:description" content="Before learning Rust, I never thought about object lifetime and ownership that much. It turns out they have many things to do with memory safety and thread safety. Nowadays I think about lifetime and ownership all the time, even when writing programs in C++. Here is a summary of my" />
    <meta name="twitter:url" content="https://www.ditsing.com/object-lifetime-and-ownership/" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Jing Yang 杨靖" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Lifetime" />
    <meta name="twitter:site" content="@dytsing" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "顿",
        "url": "https://www.ditsing.com/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://www.ditsing.com/content/images/2021/01/hammer_transparent.png"
        }
    },
    "author": {
        "@type": "Person",
        "name": "Jing Yang 杨靖",
        "url": "https://www.ditsing.com/author/ditsing/",
        "sameAs": []
    },
    "headline": "Object lifetime and ownership",
    "url": "https://www.ditsing.com/object-lifetime-and-ownership/",
    "datePublished": "2021-09-08T22:07:33.000Z",
    "dateModified": "2021-09-28T16:52:35.000Z",
    "keywords": "Lifetime",
    "description": "Before learning Rust, I never thought about object lifetime and ownership that\nmuch. It turns out they have many things to do with memory safety and thread\nsafety. Nowadays I think about lifetime and ownership all the time, even when\nwriting programs in C++. Here is a summary of my thoughts, inspired by Rust, but\napplicable to any programming language.\n\nEach object has a lifetime. An object is alive, when we can access it. In this\narticle, an &quot;object&quot; is a generic term that refers to a &quot;thing&quot; t",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://www.ditsing.com/"
    }
}
    </script>

    <meta name="generator" content="Ghost 3.42" />
    <link rel="alternate" type="application/rss+xml" title="顿" href="https://www.ditsing.com/rss/" />
    <style>
    :root {
        --color-primary: #8dd6f9;
        --color-primary-active: #1d78c1;
    }
    
    .post-content pre .lines {
        line-height: 1.66667em;
    }

    .post-content pre code {
        line-height: 1.66667em;
    }

    .post-content a:focus, .post-content a:hover {
    	box-shadow: inset 0 -3px 0 var(--color-primary-active);
	}
    
    .post-content a {
        box-shadow: inset 0 -2px 0 var(--color-primary);
    }
</style>
</head>

<body class="post-template tag-lifetime">

	<div class="nav-header">
		<nav class="nav-wrapper" aria-label="Main">
				<span class="logo">
					<a href="https://www.ditsing.com" title="Home"><img src="/content/images/2021/01/hammer_transparent.png" alt="Logo" /></a>
				</span>
				<ul>
		<li class="nav-home"><a href="https://www.ditsing.com/"><span>Home</span></a></li>
		<li class="nav-the-author"><a href="https://www.ditsing.com/author/"><span>The Author</span></a></li>
		<li class="nav-zhong-wen"><a href="https://www.ditsing.com/tag/cn/"><span>中文</span></a></li>
		<li class="nav-jian-zheng"><a href="https://www.ditsing.com/tag/jian-zheng/"><span>键政</span></a></li>
		<li class="nav-guan-yu"><a href="https://www.ditsing.com/about-me/"><span>关于</span></a></li>
		<li class="nav-jiu-bo"><a href="http://old.ditsing.com"><span>旧博</span></a></li>
</ul>

				<ul class="nav-meta">
  <li class="nav-twitter">
    <a aria-label="Twitter" href="https://twitter.com/dytsing" title="@dytsing" target="_blank">
      <i class="icon icon-twitter" aria-hidden="true"></i>
      <span>@dytsing</span>
    </a>
  </li>
  <li class="nav-github">
    <a aria-label="GitHub" href="https://github.com/ditsing" title="" target="_blank">
      <i class="icon icon-github" aria-hidden="true"></i>
      <span></span>
    </a>
  </li>
  <li class="nav-search" style="display: none;">
    <a title="Search">
      <i class="icon icon-search" aria-hidden="true"></i>
      <span>Search</span>
    </a>
  </li>
  <li class="nav-rss">
    <a title="RSS" href="https://www.ditsing.com/rss/" target="_blank">
      <i class="icon icon-rss" aria-hidden="true"></i>
    </a>
  </li>
  <!--
    <li class="nav-subscribe">
      <a href="#/portal">Subscribe</a>
    </li>
  -->
</ul>
		</nav>

		<div class="nav-wrapper-control">
			<div class="inner">
				<a class="nav-menu" role="button"><i class="icon icon-menu" aria-hidden="true"></i>Menu</a>
				<a class="nav-search" style="display: none;" title="Search" role="button"><i class="icon icon-search" aria-hidden="true"></i></a>
			</div>
		</div>
	</div>
	<div class="nav-close" role="button" aria-label="Close"></div>

	<section class="page-wrapper">

		

<div class="progress-container">
	<span class="progress-bar"></span>
</div>

<header class="post-header ">
	<div class="inner">
		<span class="post-info">
			<span class="post-type">Article</span>
			<span class="post-count">Lifetime</span>
		</span>
		<h1 class="post-title">Object lifetime and ownership</h1>
		<div class="post-meta">
			<div class="post-meta-avatars">
					<figure class="post-meta-avatar avatar">
					</figure>
			</div>
			<h4 class="post-meta-author"><a href="/author/ditsing/">Jing Yang 杨靖</a></h4>
			<time datetime="08-09-2021">08 Sep 2021</time> &bull; 5 min read
		</div>
	</div>
</header>

<main class="content" role="main">
	<article class="post tag-lifetime no-image">
		<div class="inner">

			<section class="post-content">
				<p>Before learning Rust, I never thought about object lifetime and ownership that much. It turns out they have many things to do with memory safety and thread safety. Nowadays I think about lifetime and ownership all the time, even when writing programs in C++. Here is a summary of my thoughts, inspired by Rust, but applicable to any programming language.</p><p>Each object has a lifetime. An object is alive, when we can access it. In this article, an "object" is a generic term that refers to a "thing" that represents a piece of memory or other resources. A string, an integer or a <code>struct</code> in C are all "objects".</p><h3 id="scope">Scope</h3><p>The concept of a scope is well known. In C-style languages, a scope is usually a code block. When we start executing a code block between a pair of <code>{</code> and <code>}</code>, a scope is created. When we are done with the code block, the scope is destroyed. If an object is owned by a scope, its lifetime is bounded by the scope. The object goes out of life when the scope ends. Here is a minimal example.</p><pre><code class="language-c">{ // A scope is created.
  int x = 0; // Life of x starts here.
  ...
  x += 2;
} // Life of x ends here, when the scope ends.
// Cannot use x anymore.
</code></pre><p>Two blocks can own different sets of objects. They should not access or modify variables owned by each other. This is useful when we want isolation between code blocks. Functions, closures, loop bodies, branches all create scopes. Loop bodies are special, since they are essentially many scopes that look just like each other.</p><h3 id="object-hierarchy">Object hierarchy</h3><p>Object hierarchy is also a common concept. One object can own another object. When the outer object dies, the inner object dies with it. We say the lifetime of the inner object is bounded by the outer object.</p><pre><code class="language-c">struct ShortString {
  char content[100];
  size_t len;
}
</code></pre><p>In a string, the bytes in memory are usually owned by the string itself. When the string dies, we no longer need the bytes. Thus we usually <em>choose</em> to destroy those bytes when the string goes out of life.</p><p>Both scopes and objects allow nesting. Scopes and objects can own other scopes and objects. Together they form a tree structure of ownership.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://www.ditsing.com/content/images/2021/09/Ownership.png" class="kg-image" alt><figcaption>Ownership tree. Execution order is from top to bottom. Squares are objects.</figcaption></figure><h3 id="ownership-is-useful">Ownership is useful</h3><p>Let's have a look at a classic example of unsafe memory access.</p><pre><code class="language-c">ShortString *create_empty_short_string() {
  ShortString str;
  return &amp;str;
}

int *ptr = create_empty_short_string();  // &lt;-- a scope is created and destroyed.
// str has gone out of life
// ptr points to something that does not exist.
ptr-&gt;len = 10;  // boom!
</code></pre><p>Using the concept of ownership, we can see that <code>str</code> is owned by the function scope. When that scope is gone, so is <code>str</code>. That is why we cannot safely access <code>*ptr</code>. <code>*ptr</code> is known as a "dangling pointer. This is a confusing problem for C/C++ beginners. It is easy to explain when we introduce the concept of "ownership". <strong>Ownership helps us understand memory safety.</strong></p><p>Here is another observation. In the scope/object tree, a child scope can safely access any object that belongs to its parent. The child scope lives shorter, while the object lives slightly longer. That is why the code inside an <code>if-else</code> block can always use variables in the enclosing block.</p><h4 id="passing-ownership">Passing ownership</h4><p>To exchange information between scopes, ownership of objects can be passed around. For example, when a parameter is passed to a function, so can be the ownership of the parameter. When a value is returned from a function, often the ownership is transferred from the function scope to the calling scope.</p><pre><code class="language-c">ShortString random_short_string(
  params RandomParams // Ownership of params is passed to the function.
) {  
  ShortString str;
  for (int i = 0; i &lt; params.size; i++) {
    str.content[i] = 'a' + i;
  }
  str.len = param.size;
  return str;
}

ShortString short_string = random_short_string({size = 10});
// Ownership of the string is passed to the calling scope.
</code></pre><p>Some of the C++ experts might start to scream and yell "but that value is <em>copied</em>!", <em>copy elision</em>, <em>move semantics</em> and so on. Please stop thinking about implementation details and focus on the <em>intention</em>. The intent of <code>random_short_string()</code>, is clearly to hand over <code>str</code> to any caller. No copy <em>has</em> to be made, because <code>random_short_string()</code>  does not want to keep the original copy for itself. <strong>Clear ownership helps avoid copying.</strong></p><h3 id="dynamic-lifetime">Dynamic lifetime</h3><p>We often need more flexibility than a tree structure, as well as beyond the interaction of two scopes. That flexibility can be archived by a third type of lifetime: good until deleted.</p><pre><code class="language-c">ShortString *create_short_string() {
  return new ShortString();
}

ShortString *str = create_short_string();  // &lt;-- a scope is created and destroyed.
// But the str lives beyond the scope.
str-&gt;len = sscanf("%s", &amp;str-&gt;content);

...

// This function takes ownership of str.
void print_short_string(ShortString *str) {
  // str is now owned by this function.
  str-&gt;content[str-&gt;len] = '\0';
  printf("%s\n", str-&gt;content);
  delete str;  // str dies here.
}

print_short_string(str); // str passed to the function.
str-&gt;len;  // boom! No longer safe to access str.
</code></pre><p>Unlike "owned" objects, there is little guarantee around dynamic lifetime. A pointer can point to a valid object. It can also point to an object that has been deleted. The programmer must make sure the object is still alive when dereferencing a pointer. That, as it turned out, is a super hard thing to do.</p><h4 id="easier-cases">Easier cases</h4><p>Dynamic lifetime is hard. Overtime people discovered two special cases of dynamic lifetime that are easier to reason about: single ownership and shared ownership.</p><p><strong>Single ownership</strong>: an object is passed around between scopes and objects, but at any pointing time, it can only be accessed by one owner. If the current owner decides the object is not needed anymore, the object goes out of life. It is the responsibility of the current owner to clean the object up.</p><p><strong>Shared ownership</strong>: an object is shared between many scopes and objects. The object is alive as long as one of them still needs the object. The last owner is responsible for cleaning it up. Often it is not clear which scope that would be just by reading the code.</p><p>These two cases roughly correspond to <code>std::unique_ptr</code> and <code>std::shared_ptr</code> in C++. Unfortunately the complex syntax of C++ (e.g. <code>std::move</code>, <code>&amp;&amp;</code> etc) is not really the best tool for demonstrations. We do not have a code example here. However the conclusion is clear, <strong>ownership simplifies dynamic lifetime</strong>.</p><h3 id="static-lifetime"><em>Static</em> lifetime</h3><p><em>Static</em> is such an overloaded term. It is not the opposite of "dynamic" we talked about above. Here it means "good until the end of the program". An object is said to have a static lifetime, when it is alive throughout the whole program. Such objects are usually not destroyed by user code. Making everything <em>static</em> is a good way to solve the dangling pointer problem, except that it might use too much memory.</p><h3 id="conclusion">Conclusion</h3><p>We talked about all three types of lifetime, and how "ownership" helps us with memory safety. Let's discuss how they help with thread safety in the next article.</p>
			</section>

			<section class="post-footer">

				<div class="post-share">
					<span class="post-info-label">Share</span>
					<a title="Twitter" aria-label="Twitter" class="twitter" href="https://twitter.com/share?text=Object lifetime and ownership&url=https://www.ditsing.com/object-lifetime-and-ownership/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
						<i class="icon icon-twitter" aria-hidden="true"></i>
					</a>
					<a title="Facebook" aria-label="Facebook" class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.ditsing.com/object-lifetime-and-ownership/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
						<i class="icon icon-facebook" aria-hidden="true"></i>
					</a>
					<a title="LinkedIn" aria-label="LinkedIn" class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://www.ditsing.com/object-lifetime-and-ownership//&amp;title=Object lifetime and ownership" onclick="window.open(this.href, 'linkedin-share', 'width=930,height=720');return false;">
						<i class="icon icon-linkedin" aria-hidden="true"></i>
					</a>
					<a title="Email" aria-label="Email" class="email" href="mailto:?subject=Object lifetime and ownership&amp;body=https://www.ditsing.com/object-lifetime-and-ownership/">
						<i class="icon icon-mail" aria-hidden="true"></i>
					</a>
				</div>

				<aside class="post-tags">
					<span class="post-info-label">Topic</span>
					<a href="/tag/lifetime/">Lifetime</a>
				</aside>

			</section>


			<section class="post-comments">
				<a id="show-disqus" class="post-comments-activate">Show Comments</a>
			   <div id="disqus_thread"></div>
			</section>


			<aside class="post-nav">

					<a class="post-nav-next" href="/object-lifetime-and-threading/">
						<section class="post-nav-teaser">
							<i class="icon icon-arrow-left" aria-label="Next post"></i>
							<h2 class="post-nav-title">Object lifetime and threading</h2>
							<p class="post-nav-excerpt">Last time we talked about object lifetime and ownership. Naturally scopes and&hellip;</p>
							<p class="post-nav-meta"><time datetime="25-09-2021">25 Sep 2021</time></p>
						</section>
					</a>

					<a class="post-nav-prev" href="/two-ways-to-write-binary-search/">
						<section class="post-nav-teaser">
							<i class="icon icon-arrow-right" aria-label="Previous post"></i>
							<h2 class="post-nav-title">Two ways to implement binary search</h2>
							<p class="post-nav-excerpt">There are only two correct ways to implement binary search&hellip;</p>
							<p class="post-nav-meta"><time datetime="25-01-2021">25 Jan 2021</time></p>
						</section>
					</a>
				<div class="clear"></div>
			</aside>

		</div>
	</article>
</main>





		<div class="search-wrapper">
			<div class="search">
		    <form class="search-form">
          <input class="search-field" type="text" placeholder="Search …">
          <button class="search-button" type="submit">
						<i class="icon icon-search" aria-hidden="true"></i>
					</button>
		    </form>
				<div class="popular-wrapper">
					<h4 class="popular-title">Topics</h4>
					<span class="popular-tags post-tags">
								<a href='/tag/cn/'>中文: 2</a>
								<a href='/tag/raft/'>Raft: 2</a>
								<a href='/tag/lifetime/'>Lifetime: 2</a>
								<a href='/tag/gong-zuo/'>工作: 1</a>
					</span>
				</div>
				<div class="search-result"></div>
			</div>
			<button class="search-wrapper-close" aria-label="Close"></button>
		</div>

		<div class="nav-footer">
			<nav class="nav-wrapper" aria-label="Footer">
				<span class="nav-copy">顿 &copy; 2021  <a class="nav-rss" title="RSS" href="https://www.ditsing.com/rss/" target="_blank"><i class="icon icon-rss" aria-hidden="true"></i></a></span>
				<span class="nav-credits">Published with <a href="https://ghost.org">Ghost</a> &bull; Theme <a href="https://github.com/zutrinken/attila">Attila</a> &bull; <a class="menu-item js-theme" href="#" data-system="System theme" data-dark="Dark theme" data-light="Light theme"><span class="theme-icon"></span><span class="theme-text">System theme</span> </a> </span>
			</nav>
		</div>

	</section>

	<script type="text/javascript" src="/assets/js/script.js?v=5aa16560c6"></script>

	<script>
  $(document).ready(function () {
		var viewport = $(window);
		var post = $('.post-content');
		// Responsive videos with fitVids
    post.fitVids();
		// Format code blocks and add line numbers
		function codestyling() {
	    $('pre code').each(function(i, e) {
				// Code highlight
	      hljs.highlightBlock(e);
	      // No lines for plain text blocks
	      if (!$(this).hasClass('language-text')) {
	        var code = $(this);
					// Calculate amount of lines
	        var lines = code.html().split(/\n(?!$)/g).length;
	        var numbers = [];
	        if (lines > 1) {
	          lines++;
	        }
	        for (i = 1; i < lines; i++) {
	          numbers += '<span class="line" aria-hidden="true">' + i + '</span>';
	        }
	        code.parent().append('<div class="lines">' + numbers + '</div>');
	      }
	    });
	  }
	  codestyling();
		// Reading progress bar on window top
	  function readingProgress() {
			var postBottom = post.offset().top + post.height();
			var viewportHeight = viewport.height();
      var progress = 100 - (((postBottom - (viewport.scrollTop() + viewportHeight) + viewportHeight / 3) / (postBottom - viewportHeight + viewportHeight / 3)) * 100);
      $('.progress-bar').css('width', progress + '%');
      (progress > 100) ? $('.progress-container').addClass('complete'): $('.progress-container').removeClass('complete');
	  }
	  readingProgress();
		// Trigger reading progress
	  viewport.on({
	    'scroll': function() {
	      readingProgress();
	    },
	    'resize': function() {
	      readingProgress();
	    },
	    'orientationchange': function() {
	      readingProgress();
	    }
	  });
		// Check if disqus is defined by code injection
		if (typeof disqus === 'undefined') {
			// hide comment section
	    $('.post-comments').css({
	      'display': 'none'
	    });
	  } else {
	    $('#show-disqus').on('click', function() {
	      $.ajax({
	        type: "GET",
	        url: "//" + disqus + ".disqus.com/embed.js",
	        dataType: "script",
	        cache: true
	      });
	      $(this).parent().addClass('activated');
	    });
	  }
  });
</script>


	

</body>
</html>
